---
import Base from '../../layouts/Base.astro';
import CroppedImage from '../../components/CroppedImage.astro';
import { getCollection } from 'astro:content';

const photos = (await getCollection('photos'))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

function getAspectRatio(photo: typeof photos[0]) {
  const [_x, _y, w, h] = photo.data.cropArea.split(' ').map(v => parseFloat(v));
  return (w * photo.data.image.width) / (h * photo.data.image.height);
}

const aspectRatios = photos.map(p => getAspectRatio(p));
---

<Base title="Photos - Rhys Sullivan" description="Astrophotography and space photos." wide>
  <div>
    <h1 class="text-2xl font-semibold tracking-tight mb-2">space photos</h1>
    <p class="text-[var(--text-muted)] mb-8">
      captured in san francisco using my <a href="https://amzn.to/49FP2sh" target="_blank" class="underline hover:text-[var(--text)] transition-colors">dwarf 3</a>
    </p>

    {photos.length === 0 ? (
      <p class="text-[var(--text-muted)]">photos coming soon</p>
    ) : (
      <div class="relative" id="photo-grid" data-aspects={JSON.stringify(aspectRatios)}>
        {photos.map((photo, i) => (
          <a
            href={`/photos/${photo.slug}`}
            class="group block"
            data-index={i}
          >
            <figure>
              <div class="relative overflow-hidden rounded-lg bg-[var(--bg-secondary)]">
                <CroppedImage
                  src={photo.data.image}
                  alt={photo.data.alt}
                  cropArea={photo.data.cropArea}
                  class="w-full"
                />
                <figcaption class="absolute inset-x-0 bottom-0 p-3 bg-gradient-to-t from-black/70 to-transparent z-10">
                  <h3 class="font-medium text-sm text-white">{photo.data.title}</h3>
                  <span class="text-xs text-white/70">
                    {photo.data.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                  </span>
                </figcaption>
              </div>
            </figure>
          </a>
        ))}
      </div>
    )}
  </div>
  
  <script is:inline>
    (function() {
      const grid = document.getElementById('photo-grid');
      if (!grid) return;
      
      const aspects = JSON.parse(grid.dataset.aspects || '[]');
      const items = Array.from(grid.children);
      const gap = 16;
      
      function layout() {
        const gridWidth = grid.offsetWidth;
        // Guard: don't layout if grid has no width yet
        if (gridWidth <= 0) {
          requestAnimationFrame(layout);
          return;
        }
        
        const cols = window.innerWidth >= 1024 ? 3 : 2;
        const colWidth = (gridWidth - gap * (cols - 1)) / cols;
        const colHeights = new Array(cols).fill(0);
        
        items.forEach((item, i) => {
          const shortestCol = colHeights.indexOf(Math.min(...colHeights));
          const height = colWidth / aspects[i];
          
          item.style.position = 'absolute';
          item.style.width = colWidth + 'px';
          item.style.left = (shortestCol * (colWidth + gap)) + 'px';
          item.style.top = colHeights[shortestCol] + 'px';
          
          colHeights[shortestCol] += height + gap;
        });
        
        grid.style.height = Math.max(...colHeights) + 'px';
      }
      
      // Use requestAnimationFrame to ensure DOM is painted
      requestAnimationFrame(layout);
      window.addEventListener('resize', layout);
      document.addEventListener('astro:after-swap', function() {
        requestAnimationFrame(layout);
      });
    })();
  </script>
</Base>
