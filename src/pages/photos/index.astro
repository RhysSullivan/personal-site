---
import Base from '../../layouts/Base.astro';
import CroppedImage from '../../components/CroppedImage.astro';
import { getCollection } from 'astro:content';

const photos = (await getCollection('photos'))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
---

<Base title="Photos - Rhys Sullivan" description="Astrophotography and space photos." wide>
  <div>
    <h1 class="text-2xl font-semibold tracking-tight mb-2">space photos</h1>
    <p class="text-[var(--text-muted)] mb-8">
      captured inside san francisco from my patio
    </p>

    {photos.length === 0 ? (
      <p class="text-[var(--text-muted)]">photos coming soon</p>
    ) : (
      <div class="grid grid-cols-2 lg:grid-cols-3 gap-4" id="photo-grid">
        {photos.map((photo) => (
          <a
            href={`/photos/${photo.slug}`}
            class="group block"
          >
            <figure>
              <div class="relative overflow-hidden rounded-lg bg-[var(--bg-secondary)]">
                <CroppedImage
                  src={photo.data.image}
                  alt={photo.data.alt}
                  cropArea={photo.data.cropArea}
                  class="w-full"
                />
                <figcaption class="absolute inset-x-0 bottom-0 p-3 bg-gradient-to-t from-black/70 to-transparent z-10">
                  <h3 class="font-medium text-sm text-white">{photo.data.title}</h3>
                  <span class="text-xs text-white/70">
                    {photo.data.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                  </span>
                </figcaption>
              </div>
            </figure>
          </a>
        ))}
      </div>
    )}
  </div>
  
  <script>
    function initMasonry() {
      const grid = document.getElementById('photo-grid');
      if (!grid) return;
      
      const items = Array.from(grid.children) as HTMLElement[];
      const gap = 16;
      
      function layout() {
        const gridWidth = grid.offsetWidth;
        const cols = window.innerWidth >= 1024 ? 3 : 2;
        const colWidth = (gridWidth - gap * (cols - 1)) / cols;
        const colHeights = new Array(cols).fill(0);
        
        items.forEach((item) => {
          const shortestCol = colHeights.indexOf(Math.min(...colHeights));
          
          item.style.position = 'absolute';
          item.style.width = `${colWidth}px`;
          item.style.left = `${shortestCol * (colWidth + gap)}px`;
          item.style.top = `${colHeights[shortestCol]}px`;
          
          colHeights[shortestCol] += item.offsetHeight + gap;
        });
        
        grid.style.position = 'relative';
        grid.style.height = `${Math.max(...colHeights)}px`;
      }
      
      layout();
      window.addEventListener('resize', layout);
    }
    
    initMasonry();
    document.addEventListener('astro:after-swap', initMasonry);
  </script>
</Base>
