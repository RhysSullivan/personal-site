---
interface Props {
  username: string;
}

interface ContributionDay {
  count: number;
  date: string;
  level: number;
}

interface ContributionsResponse {
  contributions: ContributionDay[];
  total: Record<number, number>;
}

const { username } = Astro.props;
const year = new Date().getFullYear();

let contributions: ContributionDay[] = [];
let total = 0;

try {
  const response = await fetch(
    `https://github-contributions-api.jogruber.de/v4/${username}?y=${year}`
  );
  const data: ContributionsResponse = await response.json();
  contributions = data.contributions || [];
  total = data.total?.[year] || 0;
} catch (e) {
  console.error("Failed to fetch GitHub contributions:", e);
}

// Group contributions by week
const weeks: ContributionDay[][] = [];
for (let i = 0; i < contributions.length; i += 7) {
  weeks.push(contributions.slice(i, i + 7));
}

const colors = [
  "bg-[#161b22]",
  "bg-[#0e4429]",
  "bg-[#006d32]",
  "bg-[#26a641]",
  "bg-[#39d353]",
];
---

<div class="github-contributions">
  <div class="flex items-center gap-2 mb-2">
    <span class="text-sm text-[var(--text-muted)]">
      {total} contributions in {year}
    </span>
  </div>
  <div class="overflow-x-auto">
    <div class="inline-flex gap-[3px]">
      {
        weeks.map((week) => (
          <div class="flex flex-col gap-[3px]">
            {week.map((day) => (
              <div
                class={`w-[10px] h-[10px] rounded-sm ${colors[day.level] || colors[0]}`}
                title={`${day.count} contributions on ${day.date}`}
              />
            ))}
          </div>
        ))
      }
    </div>
  </div>
  <div
    class="flex justify-between mt-2 text-xs text-[var(--text-muted)]"
    style="max-width: 100%;"
  >
    <span>Jan</span>
    <span>Mar</span>
    <span>May</span>
    <span>Jul</span>
    <span>Sep</span>
    <span>Nov</span>
    <span></span>
  </div>
</div>
